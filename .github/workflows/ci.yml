# .github/workflows/ci.yml
#
# This workflow consolidates all CI checks for the Krawler project into a single file.
# It aims to improve reusability, reduce GitHub Actions execution time, and simplify
# workflow management by leveraging shared setup steps and conditional job execution.
#
# Jobs are organized to run in parallel where possible, with dependencies ensuring
# correct execution order for related tasks. Caching is utilized for Gradle and Node.js
# dependencies to speed up subsequent runs.
#
# Workflow Triggers:
# - On push to main, feature, bugfix, fix, and docs branches.
# - On pull request targeting the main branch.
#
# Jobs:
# - setup-gradle: Configures JDK and Gradle, and manages Gradle caches.
# - setup-node: Configures Node.js and installs Docusaurus dependencies.
# - kotlin-build-and-test: Runs all Kotlin-related tests (unit, functional, integration),
#   Detekt static analysis, and Kover code coverage checks.
# - codeql-analysis: Performs CodeQL static analysis for security vulnerabilities.
# - detect-site-changes: Determines if changes occurred in the 'site/' directory.
# - docusaurus-build: Builds and checks the Docusaurus site, running only if 'site/'
#   changes are detected.

name: CI

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'bugfix/**'
      - 'fix/**'
      - 'docs/**'
  pull_request:
    branches:
      - main

permissions:
  contents: read
  security-events: write # For CodeQL
  pull-requests: write # For Codecov status
  statuses: write # For Codecov status

jobs:
  # Reusable setup for Kotlin/Gradle projects
  setup-gradle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Gradle Wrapper Validation
        uses: gradle/wrapper-validation-action@v2

  # Reusable setup for Node.js projects
  setup-node:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci
        working-directory: site

  kotlin-build-and-test:
    name: Kotlin Build and Test
    needs: setup-gradle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle.lockfile') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java-kotlin
          dependency-caching: true

      - name: Run Unit Tests
        run: ./gradlew jvmTest

      - name: Run Detekt Static Analysis
        run: ./gradlew detekt detektJvmMain

      - name: Run Integration Tests
        run: ./gradlew integrationTest

      - name: Run Functional Tests
        run: ./gradlew functionalTest

      - name: Run tests and generate Kover report
        run: ./gradlew koverXmlReport

      - name: Upload coverage report to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: build/reports/kover/report.xml
          fail_ci_if_error: true

      - name: Verify the coverage
        run: ./gradlew koverVerify

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  detect-site-changes:
    runs-on: ubuntu-latest
    outputs:
      site_changed: ${{ steps.check_changes.outputs.site_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Required for git diff to work correctly

      - name: Check for site changes
        id: check_changes
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if git diff --quiet ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- site/; then
              echo "site_changed=false" >> $GITHUB_OUTPUT
            else
              echo "site_changed=true" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            if git diff --quiet HEAD^ HEAD -- site/; then
              echo "site_changed=false" >> $GITHUB_OUTPUT
            else
              echo "site_changed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "site_changed=false" >> $GITHUB_OUTPUT # Default to false for other events
          fi
        shell: bash

  docusaurus-build:
    name: Build Docusaurus Site
    needs: [setup-node, detect-site-changes]
    if: needs.detect-site-changes.outputs.site_changed == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: site
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check Docusaurus Config
        run: npx docusaurus swizzle --help > /dev/null || true

      - name: Build Docusaurus site
        run: npm run build
